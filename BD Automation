#!/bin/bash

# Set these variables appropriately
BITBUCKET_USER="your_username"
BITBUCKET_PASS="your_password_or_app_password"
BITBUCKET_WORKSPACE="your_workspace_or_project_key"
BITBUCKET_API_URL="https://api.bitbucket.org/2.0/repositories/${BITBUCKET_WORKSPACE}"
LOCAL_DIR="/path/to/local/repos"

# Create local directory if not exists
mkdir -p "$LOCAL_DIR"
cd "$LOCAL_DIR" || exit 1

# Temporary file to store repo names
tmpfile=$(mktemp)

url="$BITBUCKET_API_URL"

# Fetch all repos (handle pagination)
while [ ! -z "$url" ]; do
  echo "Fetching from URL: $url"
  
  # Fetch API response with curl (skip SSL verify if needed)
  response=$(curl -s --insecure -u "$BITBUCKET_USER:$BITBUCKET_PASS" "$url")
  
  # Extract repo slugs ("slug": "repo-name") and append to tmpfile
  echo "$response" | grep -o '"slug": *"[^"]*"' | sed 's/"slug": *"\([^"]*\)"/\1/' >> "$tmpfile"
  
  # Get next page URL if exists
  next_url=$(echo "$response" | grep -o '"next": *"[^"]*"' | sed 's/"next": *"\([^"]*\)"/\1/')
  
  url="$next_url"
done

# Read all repo names into an array
repos=()
while IFS= read -r line; do
  # Trim whitespace just in case
  repo=$(echo "$line" | xargs)
  repos+=("$repo")
done < "$tmpfile"

# Delete temp file
rm "$tmpfile"

declare -A build_results

# Process each repo
for repo in "${repos[@]}"; do
  echo "Processing repo: $repo"
  
